name: deck-build

on:
  push:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Node & npm versions
        shell: bash
        run: |
          set -euxo pipefail
          node -v
          npm -v

      - name: Install deps
        run: npm ci

      # Debug vor Ensure layout-map
      - name: Debug tree
        shell: bash
        run: |
          set -euxo pipefail
          pwd
          echo "Branch: $GITHUB_REF  SHA: $GITHUB_SHA"
          ls -la
          ls -la layouts || true
          if [ -f "layouts/template_map.json" ]; then
            echo "FOUND layouts/template_map.json"
            head -n 40 layouts/template_map.json || true
          else
            echo "NOT FOUND: layouts/template_map.json"
          fi
          if [ -f "tools/map/template.pptx" ]; then
            echo "FOUND tools/map/template.pptx"
          else
            echo "NOT FOUND: tools/map/template.pptx"
          fi
          find . -maxdepth 3 -type f | sort | sed -n '1,200p' || true

      - name: Ensure layout-map
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f "layouts/template_map.json" ]; then
            echo "template_map.json exists â€” skip map"
          elif [ -f "tools/map/template.pptx" ]; then
            npm run map
          else
            echo "::error title=Missing layout map::Commit layouts/template_map.json OR commit tools/map/template.pptx so we can generate it."
            exit 1
          fi

      - name: Select layouts (rules)
        run: npm run select
      
      - name: Sanitize layout map
        run: npm run sanitize


      - name: Validate (schemas, contrast, overlaps)
        run: npm run validate

      - name: Render PPTX
        run: npm run render

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deck-build-${{ github.run_number }}
          path: |
            dist/output.pptx
            layouts/template_map.json
            content/final.content.json
          if-no-files-found: error
